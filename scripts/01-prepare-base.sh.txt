#!/bin/bash
# 基础环境配置脚本（需 root 权限）

set -e

# 配置 hosts
cat >> /etc/hosts <<EOF
192.168.10.11 master1
192.168.10.12 master2
192.168.10.13 master3
192.168.10.14 worker1
192.168.10.100 vip
EOF

# 关闭防火墙和 SELinux
systemctl stop firewalld && systemctl disable firewalld
setenforce 0
sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config

# 关闭 swap
swapoff -a
sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

# 时间同步
dnf install -y chrony
systemctl enable --now chronyd

# 内核模块
cat > /etc/modules-load.d/k8s.conf <<EOF
overlay
br_netfilter
EOF
modprobe overlay
modprobe br_netfilter

# 内核参数
cat > /etc/sysctl.d/k8s.conf <<EOF
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
vm.swappiness = 0
EOF
sysctl --system

# 安装基础工具
dnf install -y vim wget curl net-tools nfs-utils ipvsadm bash-completion yum-utils

echo "基础环境配置完成，建议重启系统。"